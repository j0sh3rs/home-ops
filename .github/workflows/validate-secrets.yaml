---
name: Validate Secrets

on:
  pull_request:
    paths:
      - '**/*.sops.yaml'
      - '.sops.yaml'
  push:
    branches:
      - main
    paths:
      - '**/*.sops.yaml'
      - '.sops.yaml'

jobs:
  check-encryption:
    name: Verify SOPS Encryption
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install SOPS
        run: |
          SOPS_VERSION="v3.9.3"
          curl -LO "https://github.com/getsops/sops/releases/download/${SOPS_VERSION}/sops-${SOPS_VERSION}.linux.amd64"
          chmod +x "sops-${SOPS_VERSION}.linux.amd64"
          sudo mv "sops-${SOPS_VERSION}.linux.amd64" /usr/local/bin/sops
          sops --version

      - name: Verify All *.sops.yaml Files Are Encrypted
        run: |
          EXIT_CODE=0
          SOPS_FILES=$(find . -name "*.sops.yaml" -not -path "./.git/*" -type f)

          if [ -z "$SOPS_FILES" ]; then
            echo "‚ÑπÔ∏è  No *.sops.yaml files found to validate"
            exit 0
          fi

          echo "üîç Checking SOPS encryption for files:"
          echo "$SOPS_FILES" | sed 's/^/  /'
          echo ""

          for file in $SOPS_FILES; do
            # Check if file has sops metadata section indicating encryption
            if grep -q "^sops:" "$file"; then
              # Verify the sops section has actual encryption metadata
              if grep -A 5 "^sops:" "$file" | grep -q -E "(kms|age|pgp):"; then
                echo "‚úÖ $file is properly encrypted"
              else
                echo "‚ùå ERROR: $file has 'sops:' section but no encryption metadata!"
                EXIT_CODE=1
              fi
            else
              # Check if file contains unencrypted sensitive data
              if grep -q -E "^(data|stringData):" "$file"; then
                echo "‚ö†Ô∏è  WARNING: $file has data/stringData but no SOPS encryption!"
                echo "    This file MUST be encrypted before committing."
                EXIT_CODE=1
              else
                echo "‚ùå ERROR: $file is not encrypted with SOPS!"
                EXIT_CODE=1
              fi
            fi
          done

          echo ""
          if [ $EXIT_CODE -eq 0 ]; then
            echo "üéâ All *.sops.yaml files are properly encrypted"
          else
            echo "üí• SOPS encryption validation FAILED!"
            echo ""
            echo "To encrypt a file, run:"
            echo "  sops --encrypt --in-place path/to/file.sops.yaml"
            echo ""
            echo "Or use the task runner:"
            echo "  task sops:encrypt-file file=path/to/file.sops.yaml"
          fi

          exit $EXIT_CODE

      - name: Check for Accidentally Committed Plaintext Secrets
        run: |
          EXIT_CODE=0

          # Look for common secret patterns in regular YAML files (non-sops)
          echo "üîç Scanning for potential plaintext secrets in non-encrypted files..."

          # Patterns that might indicate secrets
          PATTERNS=(
            "password:"
            "secret:"
            "token:"
            "api[_-]?key:"
            "private[_-]?key:"
          )

          for pattern in "${PATTERNS[@]}"; do
            # Search in YAML files that are NOT .sops.yaml files
            MATCHES=$(find . -name "*.yaml" -o -name "*.yml" | \
                     grep -v ".sops.yaml" | \
                     grep -v ".git/" | \
                     xargs grep -l -i "$pattern" 2>/dev/null || true)

            if [ ! -z "$MATCHES" ]; then
              echo "‚ö†Ô∏è  Found potential secrets (pattern: $pattern):"
              echo "$MATCHES" | sed 's/^/    /'
              echo "    Please verify these files don't contain real secrets."
              echo "    If they do, move to *.sops.yaml files and encrypt."
              echo ""
            fi
          done

          echo "‚úÖ Plaintext secret scan completed"
