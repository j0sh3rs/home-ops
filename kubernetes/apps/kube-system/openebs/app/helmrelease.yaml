---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/helmrepository-source-v1.json
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: openebs
  namespace: kube-system
spec:
  interval: 1h
  url: https://openebs.github.io/openebs
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/helmrelease-helm-v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: openebs
  namespace: kube-system
spec:
  interval: 1h
  chart:
    spec:
      chart: openebs
      version: 4.x
      sourceRef:
        kind: HelmRepository
        name: openebs
        namespace: kube-system
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    # LocalPV Provisioner - Primary storage engine
    localprovisioner:
      enabled: true
      replicas: 3
      enableLeaderElection: false
      resources:
        limits:
          cpu: 500m
          memory: 500Mi
        requests:
          cpu: 100m
          memory: 128Mi
      basePath: "/var/openebs/local"
      enableHostpathClass: true
      enableDeviceClass: true
      hostpathClass:
        name: openebs-localpv-hostpath
        enabled: true
        isDefaultClass: true
        reclaimPolicy: Delete
        volumeBindingMode: WaitForFirstConsumer
      deviceClass:
        name: openebs-localpv-device
        enabled: true
        isDefaultClass: false
        reclaimPolicy: Delete
        volumeBindingMode: WaitForFirstConsumer
        fsType: "ext4"
    # Node Disk Manager - for device discovery
    ndm:
      enabled: true
      resources:
        limits:
          cpu: 100m
          memory: 256Mi
        requests:
          cpu: 50m
          memory: 64Mi
    # Disable engines not needed for LocalPV + S3 snapshot strategy
    mayastor:
      enabled: false
    # Disable ZFS LocalPV (not using ZFS)
    zfs-localpv:
      enabled: false
    # Disable LVM LocalPV (not using LVM)
    lvm-localpv:
      enabled: false
    # Disable built-in Loki (using existing LGTM stack)
    loki:
      enabled: false
    # Disable built-in Minio (using existing Minio S3)
    minio:
      enabled: false
    alloy:
      enabled: false
