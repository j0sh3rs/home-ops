---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: infrastructure-health-alerts
  namespace: monitoring
  labels:
    app.kubernetes.io/part-of: kube-prometheus-stack
spec:
  groups:
    # Flux GitOps Controllers
    - name: flux-controllers
      interval: 30s
      rules:
        - alert: FluxControllerDown
          expr: |
            kube_deployment_status_replicas_available{namespace="flux-system", deployment=~"(helm-controller|kustomize-controller|notification-controller|source-controller)"} == 0
          for: 5m
          labels:
            severity: critical
            component: gitops
          annotations:
            summary: "Flux controller {{ $labels.deployment }} is unavailable"
            description: "The Flux controller {{ $labels.deployment }} in namespace {{ $labels.namespace }} has no available replicas for more than 5 minutes. GitOps operations may be impacted."

        - alert: FluxOperatorDown
          expr: |
            kube_deployment_status_replicas_available{namespace="flux-system", deployment="flux-operator"} == 0
          for: 5m
          labels:
            severity: critical
            component: gitops
          annotations:
            summary: "Flux Operator is unavailable"
            description: "The Flux Operator in namespace flux-system has no available replicas for more than 5 minutes. This may prevent GitOps reconciliation."

        - alert: FluxReconciliationFailure
          expr: |
            increase(gotk_reconcile_condition{type="Ready", status="False"}[10m]) > 5
          for: 10m
          labels:
            severity: warning
            component: gitops
          annotations:
            summary: "High Flux reconciliation failure rate"
            description: "Flux resource {{ $labels.name }} in namespace {{ $labels.namespace }} has failed reconciliation more than 5 times in the last 10 minutes."

    # Certificate Management
    - name: cert-manager
      interval: 30s
      rules:
        - alert: CertManagerDown
          expr: |
            kube_deployment_status_replicas_available{namespace="cert-manager", deployment=~"(cert-manager|cert-manager-cainjector|cert-manager-webhook)"} == 0
          for: 5m
          labels:
            severity: critical
            component: certificates
          annotations:
            summary: "cert-manager component {{ $labels.deployment }} is unavailable"
            description: "The cert-manager component {{ $labels.deployment }} has no available replicas for more than 5 minutes. Certificate operations may be impacted."

        - alert: CertificateExpiringSoon
          expr: |
            certmanager_certificate_expiration_timestamp_seconds - time() < (7 * 24 * 60 * 60)
          for: 1h
          labels:
            severity: warning
            component: certificates
          annotations:
            summary: "Certificate {{ $labels.name }} expiring soon"
            description: "Certificate {{ $labels.name }} in namespace {{ $labels.namespace }} will expire in less than 7 days."

        - alert: CertificateNotReady
          expr: |
            certmanager_certificate_ready_status{condition="False"} == 1
          for: 15m
          labels:
            severity: warning
            component: certificates
          annotations:
            summary: "Certificate {{ $labels.name }} is not ready"
            description: "Certificate {{ $labels.name }} in namespace {{ $labels.namespace }} has been in a not-ready state for more than 15 minutes."

    # Cluster Networking
    - name: networking
      interval: 30s
      rules:
        - alert: CoreDNSDown
          expr: |
            kube_deployment_status_replicas_available{namespace="kube-system", deployment="coredns"} == 0
          for: 3m
          labels:
            severity: critical
            component: networking
          annotations:
            summary: "CoreDNS is unavailable"
            description: "CoreDNS has no available replicas for more than 3 minutes. DNS resolution in the cluster will fail."

        - alert: CiliumOperatorDown
          expr: |
            kube_deployment_status_replicas_available{namespace="kube-system", deployment="cilium-operator"} == 0
          for: 5m
          labels:
            severity: critical
            component: networking
          annotations:
            summary: "Cilium Operator is unavailable"
            description: "Cilium Operator has no available replicas for more than 5 minutes. CNI operations may be impacted."

        - alert: CiliumAgentDown
          expr: |
            kube_daemonset_status_number_ready{namespace="kube-system", daemonset="cilium"} < kube_daemonset_status_desired_number_scheduled{namespace="kube-system", daemonset="cilium"}
          for: 5m
          labels:
            severity: critical
            component: networking
          annotations:
            summary: "Cilium agents not running on all nodes"
            description: "{{ $value }} Cilium agent pods are not running. Expected: {{ $labels.desired }}. Pod networking may be degraded on some nodes."

    # Ingress and Gateway
    - name: gateways
      interval: 30s
      rules:
        - alert: EnvoyGatewayDown
          expr: |
            kube_deployment_status_replicas_available{namespace="network", deployment=~"envoy-(external|internal)"} == 0
          for: 5m
          labels:
            severity: critical
            component: ingress
          annotations:
            summary: "Envoy Gateway {{ $labels.deployment }} is unavailable"
            description: "Envoy Gateway {{ $labels.deployment }} has no available replicas for more than 5 minutes. External access may be impacted."

        - alert: EnvoyGatewayControllerDown
          expr: |
            kube_deployment_status_replicas_available{namespace="network", deployment="envoy-gateway"} == 0
          for: 5m
          labels:
            severity: critical
            component: ingress
          annotations:
            summary: "Envoy Gateway controller is unavailable"
            description: "The Envoy Gateway controller has no available replicas for more than 5 minutes. Gateway configuration updates will fail."

    # Storage
    - name: storage
      interval: 30s
      rules:
        - alert: PersistentVolumeFillingUp
          expr: |
            (kubelet_volume_stats_used_bytes / kubelet_volume_stats_capacity_bytes) > 0.85
          for: 15m
          labels:
            severity: warning
            component: storage
          annotations:
            summary: "PVC {{ $labels.persistentvolumeclaim }} is filling up"
            description: "PersistentVolumeClaim {{ $labels.persistentvolumeclaim }} in namespace {{ $labels.namespace }} is {{ $value | humanizePercentage }} full."

        - alert: PersistentVolumeCritical
          expr: |
            (kubelet_volume_stats_used_bytes / kubelet_volume_stats_capacity_bytes) > 0.95
          for: 5m
          labels:
            severity: critical
            component: storage
          annotations:
            summary: "PVC {{ $labels.persistentvolumeclaim }} is critically full"
            description: "PersistentVolumeClaim {{ $labels.persistentvolumeclaim }} in namespace {{ $labels.namespace }} is {{ $value | humanizePercentage }} full. Immediate action required."

    # Node Health
    - name: nodes
      interval: 30s
      rules:
        - alert: NodeNotReady
          expr: |
            kube_node_status_condition{condition="Ready", status="true"} == 0
          for: 5m
          labels:
            severity: critical
            component: nodes
          annotations:
            summary: "Node {{ $labels.node }} is not ready"
            description: "Node {{ $labels.node }} has been in a NotReady state for more than 5 minutes."

        - alert: NodeMemoryPressure
          expr: |
            kube_node_status_condition{condition="MemoryPressure", status="true"} == 1
          for: 5m
          labels:
            severity: warning
            component: nodes
          annotations:
            summary: "Node {{ $labels.node }} has memory pressure"
            description: "Node {{ $labels.node }} is experiencing memory pressure for more than 5 minutes."

        - alert: NodeDiskPressure
          expr: |
            kube_node_status_condition{condition="DiskPressure", status="true"} == 1
          for: 5m
          labels:
            severity: warning
            component: nodes
          annotations:
            summary: "Node {{ $labels.node }} has disk pressure"
            description: "Node {{ $labels.node }} is experiencing disk pressure for more than 5 minutes."
