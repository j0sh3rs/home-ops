---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: victoria-metrics-k8s-stack
spec:
  interval: 30m
  chart:
    spec:
      chart: victoria-metrics-k8s-stack
      version: 0.63.5
      sourceRef:
        kind: HelmRepository
        name: victoriametrics
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  values:
    # VictoriaMetrics Operator Configuration
    victoria-metrics-operator:
      enabled: true
      operator:
        disable_prometheus_converter: false # Keep Prometheus CRD compatibility
        enable_converter_ownership: true # VMAgent owns converted ServiceMonitors
    # VMAgent - Metrics Scraping with ServiceMonitor Discovery
    vmagent:
      enabled: true
      spec:
        selectAllByDefault: true # AC-vm-007-01: Auto-discover all ServiceMonitors
        scrapeInterval: 30s
        externalLabels:
          cluster: home-ops
        remoteWrite:
          - url: http://vmsingle-victoria-metrics-k8s-stack.monitoring.svc:8429/api/v1/write
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            memory: 1Gi
    # VMSingle - Metrics Storage with S3 Backend (Minio Compatible)
    vmsingle:
      enabled: true
      spec:
        retentionPeriod: "30d"
        replicaCount: 1
        # Environment variables for S3 credentials (Tempo lessons learned)
        extraEnv:
          - name: S3_ACCESS_KEY_ID
            valueFrom:
              secretKeyRef:
                name: victoriametrics-s3-secret
                key: S3_ACCESS_KEY_ID
          - name: S3_SECRET_ACCESS_KEY
            valueFrom:
              secretKeyRef:
                name: victoriametrics-s3-secret
                key: S3_SECRET_ACCESS_KEY
        # S3 configuration with Minio compatibility (forcepathstyle, region=minio)
        extraArgs:
          envflag.enable: "true"
          envflag.prefix: VM_
          loggerFormat: json
          remoteStorage.s3.endpoint: "https://s3.68cc.io"
          remoteStorage.s3.region: minio # Minio compatibility
          remoteStorage.s3.bucket: victoriametrics-data
          remoteStorage.s3.forcePathStyle: "true" # Path-style URLs for Minio
        resources:
          requests:
            cpu: 500m
            memory: 512Mi
          limits:
            memory: 2Gi # AC-vm-001-05: Home-lab constraint
    # VMAlert - Alerting Rules Evaluation
    vmalert:
      enabled: true
      spec:
        replicaCount: 1
        evaluationInterval: 30s
        datasource:
          url: http://vmsingle-victoria-metrics-k8s-stack.monitoring.svc:8429
        notifiers:
          - url: http://vmalertmanager-victoria-metrics-k8s-stack.monitoring.svc:9093
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            memory: 512Mi
    # VMAlertmanager - Alert Routing and Notification
    vmalertmanager:
      enabled: true
      spec:
        replicaCount: 1
        resources:
          requests:
            cpu: 50m
            memory: 128Mi
          limits:
            memory: 512Mi
    # Grafana Integration - Disable built-in Grafana (using existing)
    grafana:
      enabled: false
    # Prometheus Operator CRD Support
    prometheus-operator-crds:
      enabled: true
    # Disable components we don't need
    alertmanager:
      enabled: false
    prometheus:
      enabled: false
    kubeStateMetrics:
      enabled: false
    nodeExporter:
      enabled: false
