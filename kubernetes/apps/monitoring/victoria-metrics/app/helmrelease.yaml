---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: victoria-metrics-k8s-stack
spec:
  interval: 30m
  chart:
    spec:
      chart: victoria-metrics-k8s-stack
      version: 0.63.5
      sourceRef:
        kind: HelmRepository
        name: victoriametrics
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  values:
    # VictoriaMetrics Operator Configuration
    victoria-metrics-operator:
      enabled: true
      operator:
        disable_prometheus_converter: false # Keep Prometheus CRD compatibility
        enable_converter_ownership: true # VMAgent owns converted ServiceMonitors
    # VMAgent - Metrics Scraping with ServiceMonitor Discovery
    vmagent:
      enabled: true
      spec:
        selectAllByDefault: true # AC-vm-007-01: Auto-discover all ServiceMonitors
        scrapeInterval: 30s
        externalLabels:
          cluster: home-ops
        remoteWrite:
          - url: http://vmsingle-victoria-metrics-k8s-stack.monitoring.svc:8429/api/v1/write
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            memory: 1Gi
    # VMSingle - Metrics Storage (Local PV + S3 Backups via vmbackup)
    vmsingle:
      enabled: true
      spec:
        retentionPeriod: "30d"
        replicaCount: 1

        # Local storage configuration
        storage:
          volumeClaimTemplate:
            spec:
              storageClassName: openebs-localpv-hostpath
              accessModes:
                - ReadWriteOnce
              resources:
                requests:
                  storage: 50Gi

        # Basic logging configuration
        extraArgs:
          loggerFormat: json

        # vmbackup - S3 Backup Configuration
        vmBackup:
          acceptEULA: true
          spec:
            # Environment variables for S3 credentials
            extraEnv:
              - name: AWS_ACCESS_KEY_ID
                valueFrom:
                  secretKeyRef:
                    name: victoriametrics-s3-secret
                    key: S3_ACCESS_KEY_ID
              - name: AWS_SECRET_ACCESS_KEY
                valueFrom:
                  secretKeyRef:
                    name: victoriametrics-s3-secret
                    key: S3_SECRET_ACCESS_KEY
            # S3 destination with Minio compatibility
            destination: "s3://victoriametrics-data/?region=minio&force_path_style=true&endpoint=https://s3.68cc.io"
            # Backup schedule (daily at 02:00)
            extraArgs:
              snapshot.createURL: "http://localhost:8429/snapshot/create"
            resources:
              requests:
                cpu: 100m
                memory: 128Mi
              limits:
                memory: 512Mi
            # Daily backup schedule
            schedule: "0 2 * * *"

        resources:
          requests:
            cpu: 500m
            memory: 512Mi
          limits:
            memory: 2Gi # AC-vm-001-05: Home-lab constraint
    # VMAlert - Alerting Rules Evaluation
    vmalert:
      enabled: true
      spec:
        replicaCount: 1
        evaluationInterval: 30s
        datasource:
          url: http://vmsingle-victoria-metrics-k8s-stack.monitoring.svc:8429
        notifiers:
          - url: http://vmalertmanager-victoria-metrics-k8s-stack.monitoring.svc:9093
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            memory: 512Mi
    # VMAlertmanager - Alert Routing and Notification
    vmalertmanager:
      enabled: true
      spec:
        replicaCount: 1
        resources:
          requests:
            cpu: 50m
            memory: 128Mi
          limits:
            memory: 512Mi
    # Grafana Integration - Disable built-in Grafana (using existing)
    grafana:
      enabled: false
    # Prometheus Operator CRD Support
    prometheus-operator-crds:
      enabled: true
    # Disable components we don't need
    alertmanager:
      enabled: false
    prometheus:
      enabled: false
    kubeStateMetrics:
      enabled: false
    nodeExporter:
      enabled: false
