---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: opentelemetry-kube-stack
spec:
  interval: 30m
  chartRef:
    kind: OCIRepository
    name: opentelemetry-kube-stack
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  values:
    fullnameOverride: otel
    clusterName: home-ops
    opentelemetry-operator:
      enabled: true
      manager:
        collectorImage:
          repository: otel/opentelemetry-collector-k8s
      admissionWebhooks:
        failurePolicy: Ignore
      crds:
        create: false
    collectors:
      daemon:
        enabled: true
        mode: statefulset
        clusterRoleBinding:
          enabled: true
          clusterRoleName: ""
        image:
          repository: otel/opentelemetry-collector-k8s
          pullPolicy: Always
          # renovate: datasource=docker depName=otel/opentelemetry-collector-k8s
          tag: "0.142.0"
          digest: "sha256:a632bb31297610fd55aad37dcb78cc364a034ef47e55a691f228784b499e6220"
        resources:
          limits:
            cpu: 750m
            memory: 2Gi
          requests:
            cpu: 100m
            memory: 256Mi
        targetAllocator:
          enabled: true
          image: ghcr.io/open-telemetry/opentelemetry-operator/target-allocator:main
          serviceAccount: opentelemetry-targetallocator-sa
          prometheusCR:
            enabled: true
            podMonitorSelector: {}
            scrapeInterval: "30s"
            serviceMonitorSelector: {}
        presets:
          logsCollection:
            enabled: true
            includeCollectorLogs: false
            storeCheckpoints: false
          hostMetrics:
            enabled: true
          kubeletMetrics:
            enabled: true
          kubernetesAttributes:
            enabled: true
        config:
          receivers:
            prometheus:
              config:
                scrape_configs: []
            otlp:
              protocols:
                grpc:
                  endpoint: ${env:MY_POD_IP}:4317
                http:
                  endpoint: ${env:MY_POD_IP}:4318
          processors:
            batch:
              send_batch_size: 10000
              send_batch_max_size: 11000
              timeout: 10s
            resource:
              attributes:
                # Map k8s attributes to VictoriaLogs stream fields
                - key: k_namespace_name
                  from_attribute: k8s.namespace.name
                  action: insert
                - key: k_pod_name
                  from_attribute: k8s.pod.name
                  action: insert
                - key: stream
                  from_attribute: stream
                  action: upsert

          exporters:
            # prometheusremotewrite:
            #   endpoint: http://mimir.monitoring.svc.cluster.local:8080/api/v1/push
            otlphttp:
              logs_endpoint: http://victoria-logs-server.monitoring.svc.cluster.local:9428/insert/opentelemetry/v1/logs
              compression: gzip
              retry_on_failure:
                enabled: true
                max_elapsed_time: 300s
              sending_queue:
                enabled: true
                num_consumers: 10
                queue_size: 5000
              metrics_endpoint: http://mimir.monitoring.svc.cluster.local:8080/otlp/v1/metrics
          service:
            pipelines:
              logs:
                receivers: [filelog]
                processors: [k8sattributes, resource, batch]
                exporters: [otlphttp]

              # Updated metrics pipeline with Prometheus + Mimir
              metrics:
                receivers: [prometheus, hostmetrics, kubeletstats, otlp]
                processors: [k8sattributes, batch]
                exporters: [otlphttp]
        podMonitor:
          enabled: true
          metricsEndpoints:
            - port: metrics
              interval: 30s
    defaultCRConfig:
      enabled: false
    presets:
      clusterMetrics:
        enabled: true
    kubernetesServiceMonitors:
      enabled: true
    instrumentation:
      enabled: false
    opAMPBridge:
      enabled: false
    kubeControllerManager:
      enabled: true
    kubeScheduler:
      enabled: true
    kubeProxy:
      enabled: true
    nodeExporter:
      enabled: true
    kubeStateMetrics:
      enabled: true
