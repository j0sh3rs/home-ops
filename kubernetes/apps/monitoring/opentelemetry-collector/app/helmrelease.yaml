---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: opentelemetry-collector
spec:
  interval: 30m
  chartRef:
    kind: OCIRepository
    name: opentelemetry-collector
    namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  values:
    mode: daemonset

    presets:
      logsCollection:
        enabled: true
        includeCollectorLogs: false

    rbac:
      create: true

    serviceAccount:
      create: true

    ports:
      metrics:
        enabled: true
        containerPort: 8888
        servicePort: 8888
        protocol: TCP

    serviceMonitor:
      enabled: true
      metricsEndpoints:
        - port: metrics
          interval: 30s

    resources:
      limits:
        memory: 512Mi
      requests:
        cpu: 100m
        memory: 256Mi

    extraVolumes:
      - name: varlogpods
        hostPath:
          path: /var/log/pods

    extraVolumeMounts:
      - name: varlogpods
        mountPath: /var/log/pods
        readOnly: true

    config:
      receivers:
        filelog:
          include:
            - /var/log/pods/*/*/*.log
          exclude:
            - /var/log/pods/*/otlp-collector/*.log
          start_at: end
          include_file_path: true
          include_file_name: false
          operators:
            # Parse containerd format: 2024-01-15T10:30:45.123456789Z stdout F <log message>
            - type: regex_parser
              regex: '^(?P<time>[^\s]+)\s+(?P<stream>stdout|stderr)\s+(?P<logtag>[^\s]+)\s+(?P<log>.*)$'
              timestamp:
                parse_from: attributes.time
                layout: "%Y-%m-%dT%H:%M:%S.%LZ"
            # Move log field to body
            - type: move
              from: attributes.log
              to: body
            # Extract pod info from file path
            - type: regex_parser
              regex: '^.*\/(?P<namespace>[^_]+)_(?P<pod_name>[^_]+)_(?P<uid>[^\/]+)\/(?P<container_name>[^\/]+)\/.*\.log$'
              parse_from: attributes["log.file.path"]
            # Clean up temporary attributes
            - type: remove
              field: attributes.time
            - type: remove
              field: attributes.logtag

      processors:
        batch:
          send_batch_size: 10000
          timeout: 10s

        k8sattributes:
          auth_type: serviceAccount
          passthrough: false
          extract:
            metadata:
              - k8s.namespace.name
              - k8s.pod.name
              - k8s.pod.uid
              - k8s.deployment.name
              - k8s.statefulset.name
              - k8s.daemonset.name
              - k8s.cronjob.name
              - k8s.job.name
              - k8s.node.name
              - k8s.pod.start_time
            labels:
              - tag_name: app
                key: app.kubernetes.io/name
                from: pod
          pod_association:
            - sources:
                - from: resource_attribute
                  name: k8s.pod.uid
            - sources:
                - from: resource_attribute
                  name: k8s.pod.name
            - sources:
                - from: connection

        resource:
          attributes:
            # Create stream field from stderr/stdout
            - key: stream
              from_attribute: stream
              action: upsert
            # Map k8s.namespace.name -> k_namespace_name
            - key: k_namespace_name
              from_attribute: k8s.namespace.name
              action: insert
            # Map k8s.pod.name -> k_pod_name
            - key: k_pod_name
              from_attribute: k8s.pod.name
              action: insert
            # app field already created by k8sattributes label extraction

      exporters:
        otlphttp:
          endpoint: http://victoria-logs-server.monitoring.svc.cluster.local:9428/otlp/v1/logs
          compression: gzip
          retry_on_failure:
            enabled: true
            max_elapsed_time: 300s

      service:
        pipelines:
          logs:
            receivers: [filelog]
            processors: [k8sattributes, resource, batch]
            exporters: [otlphttp]
