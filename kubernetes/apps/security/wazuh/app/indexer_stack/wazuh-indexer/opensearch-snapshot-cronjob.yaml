---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: opensearch-snapshot
  namespace: security
spec:
  # 02:00 EST = 07:00 UTC
  schedule: "0 7 * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      ttlSecondsAfterFinished: 86400
      template:
        spec:
          restartPolicy: OnFailure
          containers:
            - name: snapshot
              image: curlimages/curl:8.17.0
              command:
                - /bin/sh
                - -c
                - |
                  set -e
                  OPENSEARCH_URL="https://wazuh-indexer:9200"
                  CREDS="admin:SecretPassword"
                  SNAPSHOT_NAME="daily-$(date +%Y%m%d-%H%M%S)"
                  RETENTION_DAYS=30

                  echo "Creating snapshot: ${SNAPSHOT_NAME}"
                  # Start snapshot without waiting (avoids curl timeout issues)
                  curl -sk --connect-timeout 30 -u "${CREDS}" -X PUT \
                    "${OPENSEARCH_URL}/_snapshot/wazuh-s3-snapshots/${SNAPSHOT_NAME}" \
                    -H "Content-Type: application/json" \
                    -d '{
                      "indices": "wazuh-*",
                      "ignore_unavailable": true,
                      "include_global_state": false
                    }'

                  echo ""
                  echo "Waiting for snapshot to complete..."

                  # Poll for snapshot completion (max 5 minutes)
                  TIMEOUT=300
                  ELAPSED=0
                  while [ $ELAPSED -lt $TIMEOUT ]; do
                    STATE=$(curl -sk --connect-timeout 10 -u "${CREDS}" \
                      "${OPENSEARCH_URL}/_snapshot/wazuh-s3-snapshots/${SNAPSHOT_NAME}" | \
                      grep -oE '"state"\s*:\s*"[A-Z]+"' | head -1 | sed 's/.*"state"\s*:\s*"//;s/"$//')

                    if [ "$STATE" = "SUCCESS" ]; then
                      echo "Snapshot ${SNAPSHOT_NAME} completed successfully"
                      break
                    elif [ "$STATE" = "FAILED" ] || [ "$STATE" = "PARTIAL" ]; then
                      echo "Snapshot ${SNAPSHOT_NAME} failed with state: ${STATE}"
                      exit 1
                    fi

                    sleep 5
                    ELAPSED=$((ELAPSED + 5))
                    echo "Snapshot state: ${STATE:-IN_PROGRESS}, elapsed: ${ELAPSED}s"
                  done

                  if [ $ELAPSED -ge $TIMEOUT ]; then
                    echo "Snapshot timed out after ${TIMEOUT}s"
                    exit 1
                  fi

                  # Cleanup old snapshots
                  echo "Cleaning up snapshots older than ${RETENTION_DAYS} days..."
                  # BusyBox date: calculate epoch seconds for N days ago
                  CUTOFF_EPOCH=$(($(date +%s) - RETENTION_DAYS * 86400))
                  CUTOFF_DATE=$(date -d @${CUTOFF_EPOCH} +%Y%m%d)

                  # Get list of snapshots
                  SNAPSHOTS=$(curl -sk --connect-timeout 30 -u "${CREDS}" \
                    "${OPENSEARCH_URL}/_snapshot/wazuh-s3-snapshots/_all" | \
                    grep -oE '"snapshot"\s*:\s*"daily-[0-9]+-[0-9]+"' | \
                    sed 's/"snapshot"\s*:\s*"//;s/"$//' || true)

                  for SNAP in ${SNAPSHOTS}; do
                    # Extract date from snapshot name (daily-YYYYMMDD-HHMMSS)
                    SNAP_DATE=$(echo "${SNAP}" | grep -oE '[0-9]{8}' | head -1)
                    if [ -n "${SNAP_DATE}" ] && [ "${SNAP_DATE}" -lt "${CUTOFF_DATE}" ]; then
                      echo "Deleting old snapshot: ${SNAP}"
                      curl -sk --connect-timeout 30 -u "${CREDS}" -X DELETE \
                        "${OPENSEARCH_URL}/_snapshot/wazuh-s3-snapshots/${SNAP}" || true
                    fi
                  done

                  echo "Snapshot job completed successfully"
              resources:
                requests:
                  cpu: 50m
                  memory: 64Mi
                limits:
                  cpu: 200m
                  memory: 128Mi
