<!--
  Custom Wazuh Rules for Home-Ops Security Monitoring
  Rule ID Range: 100000-120000

  Rule 1: Failed Authentication Tracking
  - Detects brute force attempts across SSH, sudo, and Kubernetes API
  - Maps to MITRE ATT&CK T1110 (Brute Force)
-->
<group name="local,authentication,">

  <!-- Base rule: SSH authentication failure -->
  <rule id="100001" level="5">
    <if_sid>5710</if_sid>
    <description>SSH: Authentication failure detected</description>
    <group>authentication_failed,pci_dss_10.2.4,pci_dss_10.2.5,</group>
  </rule>

  <!-- Frequency rule: Multiple SSH failures from same IP (brute force) -->
  <rule id="100002" level="10" frequency="5" timeframe="120">
    <if_matched_sid>100001</if_matched_sid>
    <same_srcip />
    <description>SSH: Brute force attempt - $(srcip) - Multiple authentication failures</description>
    <mitre>
      <id>T1110</id>
    </mitre>
    <group>authentication_failures,brute_force,pci_dss_11.4,gdpr_IV_35.7.d,</group>
  </rule>

  <!-- Base rule: Sudo authentication failure -->
  <rule id="100003" level="5">
    <decoded_as>sudo</decoded_as>
    <match>authentication failure</match>
    <description>Sudo: Authentication failure detected</description>
    <group>authentication_failed,</group>
  </rule>

  <!-- Frequency rule: Multiple sudo failures from same user -->
  <rule id="100004" level="10" frequency="5" timeframe="120">
    <if_matched_sid>100003</if_matched_sid>
    <same_user />
    <description>Sudo: Multiple authentication failures for user $(user)</description>
    <mitre>
      <id>T1110</id>
    </mitre>
    <group>authentication_failures,brute_force,</group>
  </rule>

  <!-- Base rule: Kubernetes API authentication failure -->
  <rule id="100005" level="5">
    <match>Unauthorized|Forbidden|authentication failed</match>
    <match>kube-apiserver</match>
    <description>Kubernetes API: Authentication failure detected</description>
    <group>authentication_failed,</group>
  </rule>

  <!-- Frequency rule: Multiple K8s API failures from same source -->
  <rule id="100006" level="10" frequency="5" timeframe="120">
    <if_matched_sid>100005</if_matched_sid>
    <same_srcip />
    <description>Kubernetes API: Brute force attempt - $(srcip) - Multiple authentication failures</description>
    <mitre>
      <id>T1110</id>
    </mitre>
    <group>authentication_failures,brute_force,kubernetes,</group>
  </rule>

</group>
