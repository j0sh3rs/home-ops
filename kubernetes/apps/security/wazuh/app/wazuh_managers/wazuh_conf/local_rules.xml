<!--
  Custom Wazuh Rules for Home-Ops Security Monitoring
  Rule ID Range: 100000-120000

  Rule 1: Failed Authentication Tracking
  - Detects brute force attempts across SSH, sudo, and Kubernetes API
  - Maps to MITRE ATT&CK T1110 (Brute Force)
-->
<group name="local,authentication,">

  <!-- Base rule: SSH authentication failure -->
  <rule id="100001" level="5">
    <if_sid>5710</if_sid>
    <description>SSH: Authentication failure detected</description>
    <group>authentication_failed,pci_dss_10.2.4,pci_dss_10.2.5,</group>
  </rule>

  <!-- Frequency rule: Multiple SSH failures from same IP (brute force) -->
  <rule id="100002" level="10" frequency="5" timeframe="120">
    <if_matched_sid>100001</if_matched_sid>
    <same_srcip />
    <description>SSH: Brute force attempt - $(srcip) - Multiple authentication failures</description>
    <mitre>
      <id>T1110</id>
    </mitre>
    <group>authentication_failures,brute_force,pci_dss_11.4,gdpr_IV_35.7.d,</group>
  </rule>

  <!-- Base rule: Sudo authentication failure -->
  <rule id="100003" level="5">
    <decoded_as>sudo</decoded_as>
    <match>authentication failure</match>
    <description>Sudo: Authentication failure detected</description>
    <group>authentication_failed,</group>
  </rule>

  <!-- Frequency rule: Multiple sudo failures from same user -->
  <rule id="100004" level="10" frequency="5" timeframe="120">
    <if_matched_sid>100003</if_matched_sid>
    <same_user />
    <description>Sudo: Multiple authentication failures for user $(user)</description>
    <mitre>
      <id>T1110</id>
    </mitre>
    <group>authentication_failures,brute_force,</group>
  </rule>

  <!-- Base rule: Kubernetes API authentication failure -->
  <rule id="100005" level="5">
    <match>Unauthorized|Forbidden|authentication failed</match>
    <match>kube-apiserver</match>
    <description>Kubernetes API: Authentication failure detected</description>
    <group>authentication_failed,</group>
  </rule>

  <!-- Frequency rule: Multiple K8s API failures from same source -->
  <rule id="100006" level="10" frequency="5" timeframe="120">
    <if_matched_sid>100005</if_matched_sid>
    <same_srcip />
    <description>Kubernetes API: Brute force attempt - $(srcip) - Multiple authentication failures</description>
    <mitre>
      <id>T1110</id>
    </mitre>
    <group>authentication_failures,brute_force,kubernetes,</group>
  </rule>

</group>

<!--
  Rule 2: Suspicious DNS Queries
  - Detects queries to known malicious domains
  - Detects cryptocurrency mining pool queries
  - Maps to MITRE ATT&CK T1071.004 (C2: DNS)
-->
<group name="local,dns,">

  <!-- Base rule: CoreDNS query log entry -->
  <rule id="100010" level="3">
    <match>coredns</match>
    <match> IN </match>
    <description>CoreDNS: DNS query detected</description>
    <group>dns_query,</group>
  </rule>

  <!-- Malicious domain query (pattern matching) -->
  <rule id="100011" level="10">
    <if_sid>100010</if_sid>
    <match>evil.com|badactor.net|malicious-c2.com|phishing-site.org|ransomware-c2.net|botnet-controller.com</match>
    <description>DNS: Query to known malicious domain - Potential C2 communication</description>
    <mitre>
      <id>T1071.004</id>
    </mitre>
    <group>dns_malicious,command_and_control,pci_dss_11.4,gdpr_IV_35.7.d,</group>
  </rule>

  <!-- Cryptocurrency mining pool query -->
  <rule id="100012" level="8">
    <if_sid>100010</if_sid>
    <match>coinhive.com|coin-hive.com|crypto-loot.com|deepminer.net|webminepool|monerominer.rocks|ppoi.org|2giga.link|joyreactor.cc</match>
    <description>DNS: Query to cryptocurrency mining pool - Potential cryptojacking</description>
    <mitre>
      <id>T1496</id>
    </mitre>
    <group>dns_cryptomining,resource_hijacking,</group>
  </rule>

  <!-- Suspicious long subdomain (potential DNS tunneling) -->
  <rule id="100013" level="8">
    <if_sid>100010</if_sid>
    <regex type="pcre2">\w{50,}\.[\w\.-]+\s+IN</regex>
    <description>DNS: Suspiciously long subdomain - Potential DNS tunneling</description>
    <mitre>
      <id>T1071.004</id>
    </mitre>
    <group>dns_tunneling,data_exfiltration,</group>
  </rule>

  <!-- Multiple queries to same malicious domain (persistence check) -->
  <rule id="100014" level="12" frequency="3" timeframe="300">
    <if_matched_sid>100011</if_matched_sid>
    <same_source_ip />
    <description>DNS: Repeated queries to malicious domain - $(url) - Persistent C2 activity</description>
    <mitre>
      <id>T1071.004</id>
    </mitre>
    <group>dns_malicious,command_and_control,persistence,</group>
  </rule>

</group>
