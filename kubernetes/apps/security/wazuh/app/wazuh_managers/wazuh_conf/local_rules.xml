<!--
  Custom Wazuh Rules for Home-Ops Security Monitoring
  Rule ID Range: 100000-120000

  Rule 1: Failed Authentication Tracking
  - Detects brute force attempts across SSH, sudo, and Kubernetes API
  - Maps to MITRE ATT&CK T1110 (Brute Force)
-->
<group name="local,authentication,">

  <!-- Base rule: SSH authentication failure -->
  <rule id="100001" level="5">
    <if_sid>5710</if_sid>
    <description>SSH: Authentication failure detected</description>
    <group>authentication_failed,pci_dss_10.2.4,pci_dss_10.2.5,</group>
  </rule>

  <!-- Frequency rule: Multiple SSH failures from same IP (brute force) -->
  <rule id="100002" level="10" frequency="5" timeframe="120">
    <if_matched_sid>100001</if_matched_sid>
    <same_srcip />
    <description>SSH: Brute force attempt - $(srcip) - Multiple authentication failures</description>
    <mitre>
      <id>T1110</id>
    </mitre>
    <group>authentication_failures,brute_force,pci_dss_11.4,gdpr_IV_35.7.d,</group>
  </rule>

  <!-- Base rule: Sudo authentication failure -->
  <rule id="100003" level="5">
    <decoded_as>sudo</decoded_as>
    <match>authentication failure</match>
    <description>Sudo: Authentication failure detected</description>
    <group>authentication_failed,</group>
  </rule>

  <!-- Frequency rule: Multiple sudo failures from same user -->
  <rule id="100004" level="10" frequency="5" timeframe="120">
    <if_matched_sid>100003</if_matched_sid>
    <same_user />
    <description>Sudo: Multiple authentication failures for user $(user)</description>
    <mitre>
      <id>T1110</id>
    </mitre>
    <group>authentication_failures,brute_force,</group>
  </rule>

  <!-- Base rule: Kubernetes API authentication failure -->
  <rule id="100005" level="5">
    <match>Unauthorized|Forbidden|authentication failed</match>
    <match>kube-apiserver</match>
    <description>Kubernetes API: Authentication failure detected</description>
    <group>authentication_failed,</group>
  </rule>

  <!-- Frequency rule: Multiple K8s API failures from same source -->
  <rule id="100006" level="10" frequency="5" timeframe="120">
    <if_matched_sid>100005</if_matched_sid>
    <same_srcip />
    <description>Kubernetes API: Brute force attempt - $(srcip) - Multiple authentication failures</description>
    <mitre>
      <id>T1110</id>
    </mitre>
    <group>authentication_failures,brute_force,kubernetes,</group>
  </rule>

</group>

<!--
  Rule 2: Suspicious DNS Queries
  - Detects queries to known malicious domains
  - Detects cryptocurrency mining pool queries
  - Maps to MITRE ATT&CK T1071.004 (C2: DNS)
-->
<group name="local,dns,">

  <!-- Base rule: CoreDNS query log entry -->
  <rule id="100010" level="3">
    <match>coredns</match>
    <match> IN </match>
    <description>CoreDNS: DNS query detected</description>
    <group>dns_query,</group>
  </rule>

  <!-- Malicious domain query (pattern matching) -->
  <rule id="100011" level="10">
    <if_sid>100010</if_sid>
    <match>evil.com|badactor.net|malicious-c2.com|phishing-site.org|ransomware-c2.net|botnet-controller.com</match>
    <description>DNS: Query to known malicious domain - Potential C2 communication</description>
    <mitre>
      <id>T1071.004</id>
    </mitre>
    <group>dns_malicious,command_and_control,pci_dss_11.4,gdpr_IV_35.7.d,</group>
  </rule>

  <!-- Cryptocurrency mining pool query -->
  <rule id="100012" level="8">
    <if_sid>100010</if_sid>
    <match>coinhive.com|coin-hive.com|crypto-loot.com|deepminer.net|webminepool|monerominer.rocks|ppoi.org|2giga.link|joyreactor.cc</match>
    <description>DNS: Query to cryptocurrency mining pool - Potential cryptojacking</description>
    <mitre>
      <id>T1496</id>
    </mitre>
    <group>dns_cryptomining,resource_hijacking,</group>
  </rule>

  <!-- Suspicious long subdomain (potential DNS tunneling) -->
  <rule id="100013" level="8">
    <if_sid>100010</if_sid>
    <regex type="pcre2">\w{50,}\.[\w\.-]+\s+IN</regex>
    <description>DNS: Suspiciously long subdomain - Potential DNS tunneling</description>
    <mitre>
      <id>T1071.004</id>
    </mitre>
    <group>dns_tunneling,data_exfiltration,</group>
  </rule>

  <!-- Multiple queries to same malicious domain (persistence check) -->
  <rule id="100014" level="12" frequency="3" timeframe="300">
    <if_matched_sid>100011</if_matched_sid>
    <same_source_ip />
    <description>DNS: Repeated queries to malicious domain - $(url) - Persistent C2 activity</description>
    <mitre>
      <id>T1071.004</id>
    </mitre>
    <group>dns_malicious,command_and_control,persistence,</group>
  </rule>

</group>

<!--
  Rule Group 2: Content Filtering (Primary User Goal: Kids Protection)
  - Detects YouTube, social media, gaming, adult content, streaming access
  - Monitors after-hours usage (bedtime enforcement: 22:00-06:00)
  - Escalating severity: access → playback → excessive usage
-->
<group name="local,content_filtering,">

  <!-- Base rule: YouTube access detection -->
  <rule id="100020" level="3">
    <match>youtube.com|youtu.be|youtubei.googleapis.com</match>
    <description>Content Filter: YouTube access detected</description>
    <group>youtube_access,content_monitoring,</group>
  </rule>

  <!-- YouTube video playback (high severity for kids protection) -->
  <rule id="100021" level="8">
    <if_sid>100020</if_sid>
    <match>watch|/v/|/embed/|videoplayback</match>
    <description>Content Filter: YouTube video playback detected - URL: $(url)</description>
    <group>youtube_video,content_monitoring,</group>
  </rule>

  <!-- Frequent YouTube access (potential binge watching) -->
  <rule id="100022" level="10" frequency="10" timeframe="3600">
    <if_matched_sid>100021</if_matched_sid>
    <same_srcip />
    <description>Content Filter: Excessive YouTube usage - $(srcip) - 10+ videos in 1 hour</description>
    <group>youtube_excessive,content_monitoring,</group>
  </rule>

  <!-- Social media access detection -->
  <rule id="100023" level="5">
    <match>facebook.com|instagram.com|tiktok.com|snapchat.com|twitter.com|x.com</match>
    <description>Content Filter: Social media access detected - $(url)</description>
    <group>social_media_access,content_monitoring,</group>
  </rule>

  <!-- Gaming site access -->
  <rule id="100024" level="5">
    <match>roblox.com|minecraft.net|fortnite.com|twitch.tv|steam</match>
    <description>Content Filter: Gaming site access detected - $(url)</description>
    <group>gaming_access,content_monitoring,</group>
  </rule>

  <!-- Adult content sites (high priority blocking) -->
  <rule id="100025" level="12">
    <match>pornhub|xvideos|xnxx|redtube|youporn|porn</match>
    <description>Content Filter: ADULT CONTENT ACCESS DETECTED - $(url) - IMMEDIATE ATTENTION</description>
    <group>adult_content,content_monitoring,high_priority,</group>
  </rule>

  <!-- Streaming services (Netflix, Disney+, etc.) -->
  <rule id="100026" level="5">
    <match>netflix.com|disneyplus.com|hulu.com|primevideo.com|hbomax.com</match>
    <description>Content Filter: Streaming service access detected - $(url)</description>
    <group>streaming_access,content_monitoring,</group>
  </rule>

  <!-- Late night internet usage (configurable for kids' bedtime) -->
  <rule id="100027" level="8">
    <if_sid>100020,100023,100024,100026</if_sid>
    <time>22:00-06:00</time>
    <description>Content Filter: Internet usage during restricted hours (22:00-06:00) - $(url)</description>
    <group>after_hours_usage,content_monitoring,</group>
  </rule>

</group>

<!--
  Rule Group 4: Privilege Escalation Detection
  - Monitors sudo to root, SUID execution, group modifications
  - Maps to MITRE ATT&CK T1548 (Abuse Elevation Control Mechanism)
-->
<group name="local,privilege_escalation,">

  <!-- Successful sudo to root -->
  <rule id="100030" level="7">
    <decoded_as>sudo</decoded_as>
    <match>successful|accepted</match>
    <match>root</match>
    <description>Privilege Escalation: Successful sudo to root by user $(user)</description>
    <mitre>
      <id>T1548.003</id>
    </mitre>
    <group>privilege_escalation,sudo_success,</group>
  </rule>

  <!-- Multiple privilege escalations in short time -->
  <rule id="100031" level="10" frequency="5" timeframe="300">
    <if_matched_sid>100030</if_matched_sid>
    <same_user />
    <description>Privilege Escalation: Multiple sudo operations by $(user) - Potential suspicious activity</description>
    <mitre>
      <id>T1548.003</id>
    </mitre>
    <group>privilege_escalation,suspicious_activity,</group>
  </rule>

  <!-- SUID/SGID file execution -->
  <rule id="100032" level="8">
    <match>setuid|setgid</match>
    <match>executed</match>
    <description>Privilege Escalation: SUID/SGID binary execution detected - $(file)</description>
    <mitre>
      <id>T1548.001</id>
    </mitre>
    <group>privilege_escalation,suid_execution,</group>
  </rule>

  <!-- User added to privileged group -->
  <rule id="100033" level="10">
    <match>usermod|adduser</match>
    <match>sudo|wheel|admin|docker</match>
    <description>Privilege Escalation: User $(user) added to privileged group</description>
    <mitre>
      <id>T1078</id>
    </mitre>
    <group>privilege_escalation,account_modification,</group>
  </rule>

</group>

<!--
  Rule Group 5: Suspicious Network Activity
  - Detects reverse shells, port scanning, data exfiltration, anonymity networks
  - Maps to MITRE ATT&CK T1071 (Application Layer Protocol), T1046 (Network Service Discovery)
-->
<group name="local,network,">

  <!-- Outbound connection to unusual port -->
  <rule id="100040" level="7">
    <match>connection established|ESTABLISHED</match>
    <match>:4444|:5555|:6666|:7777|:8888|:31337</match>
    <description>Network: Outbound connection to suspicious port - Potential reverse shell</description>
    <mitre>
      <id>T1071</id>
    </mitre>
    <group>suspicious_network,reverse_shell,</group>
  </rule>

  <!-- Frequency rule: Multiple failed connection attempts (port scanning) -->
  <rule id="100041" level="8" frequency="10" timeframe="60">
    <if_matched_sid>100044</if_matched_sid>
    <same_srcip />
    <description>Network: Multiple connection failures - Potential port scanning from $(srcip)</description>
    <mitre>
      <id>T1046</id>
    </mitre>
    <group>suspicious_network,port_scan,</group>
  </rule>

  <!-- Base rule: Connection failure detection (referenced by 100041) -->
  <rule id="100044" level="5">
    <match>connection refused|No route to host|timeout</match>
    <description>Network: Connection failure detected from $(srcip)</description>
    <group>network_failure,</group>
  </rule>

  <!-- Unusual outbound traffic volume -->
  <rule id="100042" level="8">
    <match>traffic|bandwidth|bytes sent</match>
    <regex type="pcre2">\d{8,}\s+bytes</regex>
    <description>Network: High outbound traffic volume detected - Potential data exfiltration</description>
    <mitre>
      <id>T1041</id>
    </mitre>
    <group>suspicious_network,data_exfiltration,</group>
  </rule>

  <!-- Connection to known C2 infrastructure -->
  <rule id="100043" level="12">
    <match>connection established|ESTABLISHED</match>
    <match>tor|onion|i2p</match>
    <description>Network: Connection to anonymity network (Tor/I2P) - Potential C2 communication</description>
    <mitre>
      <id>T1090</id>
    </mitre>
    <group>suspicious_network,anonymity_network,command_and_control,</group>
  </rule>

</group>

<!--
  Rule Group 6: Container/Kubernetes Security
  - Monitors container escape, privileged containers, secret access, pod exec
  - Maps to MITRE ATT&CK T1611 (Escape to Host), T1609 (Container Administration Command)
-->
<group name="local,container_security,">

  <!-- Container escape attempt -->
  <rule id="100050" level="12">
    <match>runc|container|docker</match>
    <match>escape|breakout|/proc/self/exe</match>
    <description>Container Security: Container escape attempt detected - CRITICAL</description>
    <mitre>
      <id>T1611</id>
    </mitre>
    <group>container_escape,critical_security,</group>
  </rule>

  <!-- Privileged container creation -->
  <rule id="100051" level="10">
    <match>privileged=true|--privileged</match>
    <description>Container Security: Privileged container created - Security risk</description>
    <mitre>
      <id>T1611</id>
    </mitre>
    <group>privileged_container,security_risk,</group>
  </rule>

  <!-- Kubernetes secret access -->
  <rule id="100052" level="8">
    <match>secret</match>
    <match>get|list|watch</match>
    <match>kube-apiserver</match>
    <description>Kubernetes: Secret access detected - User: $(user) - Resource: $(resource)</description>
    <group>kubernetes_security,secret_access,</group>
  </rule>

  <!-- Pod exec command (potential compromise investigation) -->
  <rule id="100053" level="7">
    <match>kubectl exec|crictl exec|docker exec</match>
    <description>Container Security: Interactive shell access to container - User: $(user)</description>
    <mitre>
      <id>T1609</id>
    </mitre>
    <group>container_access,interactive_shell,</group>
  </rule>

  <!-- Frequency rule: Multiple pod crashes (potential DoS or instability) -->
  <rule id="100054" level="8" frequency="5" timeframe="300">
    <if_matched_sid>100055</if_matched_sid>
    <description>Kubernetes: Multiple pod crashes detected - Pod: $(pod) - Potential DoS or misconfiguration</description>
    <group>kubernetes_stability,pod_crash,</group>
  </rule>

  <!-- Base rule: Pod error detection (referenced by 100054) -->
  <rule id="100055" level="5">
    <match>CrashLoopBackOff|Error|Failed</match>
    <match>pod</match>
    <description>Kubernetes: Pod error detected - Pod: $(pod)</description>
    <group>pod_error,</group>
  </rule>

</group>

<!--
  Rule Group 7: File Integrity Monitoring
  - Monitors critical system files, K8s configs, cron jobs
  - Maps to MITRE ATT&CK T1078 (Valid Accounts), T1098 (Account Manipulation), T1053.003 (Cron)
-->
<group name="local,file_integrity,">

  <!-- Critical system file modification -->
  <rule id="100060" level="10">
    <match>/etc/passwd|/etc/shadow|/etc/sudoers|/etc/ssh/sshd_config</match>
    <match>modified|changed|written</match>
    <description>File Integrity: Critical system file modified - File: $(file)</description>
    <mitre>
      <id>T1078</id>
      <id>T1098</id>
    </mitre>
    <group>file_integrity,critical_file_change,</group>
  </rule>

  <!-- Kubernetes config file modification -->
  <rule id="100061" level="10">
    <match>/etc/kubernetes|kubeconfig|.kube/config</match>
    <match>modified|changed|written</match>
    <description>File Integrity: Kubernetes configuration file modified - File: $(file)</description>
    <group>file_integrity,kubernetes_config_change,</group>
  </rule>

  <!-- New cron job created -->
  <rule id="100062" level="8">
    <match>/etc/cron|crontab</match>
    <match>created|added|modified</match>
    <description>File Integrity: Cron job modified - Potential persistence mechanism</description>
    <mitre>
      <id>T1053.003</id>
    </mitre>
    <group>file_integrity,persistence,scheduled_task,</group>
  </rule>

</group>
