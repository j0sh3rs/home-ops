---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app wazuh-cluster
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: wazuh-cluster
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  valuesFrom:
    - kind: Secret
      name: wazuh-secrets
      valuesKey: wazuhApiPassword
      targetPath: secrets.wazuhApi.password
    - kind: Secret
      name: wazuh-secrets
      valuesKey: indexerAdminPassword
      targetPath: secrets.indexerAdmin.password
    - kind: Secret
      name: wazuh-secrets
      valuesKey: wazuhAuthdPassword
      targetPath: secrets.wazuhAuthd.password
  values:
    namespace: security
    createNamespace: false
    sizing:
      profile: "M"
      storageClassName: openebs-hostpath
    cluster:
      name: wazuh
      spec:
        version: "4.14.1"
        tls:
          enabled: false
    opensearchRepository:
      enabled: true
      name: minio-backups
      spec:
        type: s3
        settings:
          bucket: wazuh-backups
          basePath: opensearch/snapshots
          endpoint: &s3-url https://s3.68cc.io
          pathStyleAccess: true
          compress: true
          credentialsSecret:
            name: wazuh-secrets
            accessKeyKey: accessKeyId
            secretKeyKey: secretAccessKey
        verify: true
    opensearchSnapshotPolicy:
      enabled: true
      name: daily-snapshots
      spec:
        description: "Daily automated snapshots"
        repository:
          name: minio-backups
        snapshotConfig:
          indices:
            - "wazuh-alerts-*"
            - "wazuh-archives-*"
        creation:
          schedule:
            expression: "0 2 * * *"
            timezone: "America/New_York"
          timeLimit: "1h"
        deletion:
          schedule:
            expression: "0 3 * * *"
          condition:
            maxAge: "30d"
            maxCount: 30
            minCount: 7
    wazuhBackup:
      enabled: true
      name: daily-backup
      spec:
        components:
          agentKeys: true
          fimDatabase: true
          agentDatabase: true
          integrations: true
          alertLogs: false
        schedule: "0 2 * * *"
        retention:
          maxBackups: 14
          maxAge: "30d"
        storage:
          type: s3
          bucket: wazuh-backups
          prefix: "home-ops/manager"
          endpoint: *s3-url
          forcePathStyle: true
          credentialsSecret:
            name: wazuh-secrets
            accessKeyKey: accessKeyId
            secretKeyKey: secretAccessKey
        backupTimeout: "30m"
