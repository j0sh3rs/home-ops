---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: traefik
  namespace: network
spec:
  interval: 30m
  chart:
    spec:
      chart: traefik
      version: "32.1.1"
      sourceRef:
        kind: HelmRepository
        name: traefik
        namespace: flux-system
  values:
    # Gateway API Provider Configuration
    providers:
      kubernetesGateway:
        enabled: true
        experimentalChannel: false # Use stable v1 API
      kubernetesCRD:
        enabled: true # For Middleware resources
        allowCrossNamespace: true # Cross-namespace middleware references
      kubernetesIngress:
        enabled: false # Disable Ingress API

    # Deployment Configuration
    deployment:
      replicas: 1 # Single replica for home-lab
      kind: Deployment

    # Resource Limits (home-lab constraints)
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 512Mi

    # Entrypoints Configuration
    ports:
      web:
        port: 80
        protocol: TCP
        exposedPort: 80
      websecure:
        port: 443
        protocol: TCP
        exposedPort: 443
        tls:
          enabled: true
      tcp-514:
        port: 514
        protocol: TCP
        exposedPort: 514
      udp-514:
        port: 514
        protocol: UDP
        exposedPort: 514
      metrics:
        port: 9100
        protocol: TCP
        expose: true # Expose for Prometheus

    # Service Configuration
    service:
      type: LoadBalancer
      annotations:
        io.cilium/lb-ipam-ips: "192.168.35.16"
      spec:
        externalTrafficPolicy: Local # Preserve client IP

    # Metrics Configuration
    metrics:
      prometheus:
        enabled: true
        entryPoint: metrics
        addEntryPointsLabels: true
        addRoutersLabels: true
        addServicesLabels: true

    # Logging Configuration
    logs:
      general:
        level: INFO
      access:
        enabled: true
        format: json
        fields:
          defaultMode: keep
          headers:
            defaultMode: drop # Drop sensitive headers
