---
date: 2026-01-08T13:34:30+0000
session_name: platform-evolution
researcher: Claude Code
git_commit: 6342dff920aae2e73570b83f187f90ab2a8d8c44
branch: main
repository: home-ops
topic: "Phase 5E Completion & Alert Tuning"
tags: [monitoring, alerts, prometheus, victorialogs, tetragon, phase-5e]
status: complete
last_updated: 2026-01-08
last_updated_by: Claude Code
type: implementation_strategy
root_span_id:
turn_span_id:
---

# Handoff: Phase 5E Documentation & Alert Tuning

## Task(s)

This session completed three tasks, all marked **COMPLETED**:

1. **Update Continuity Ledger for Phase 5E** - Updated `thoughts/ledgers/CONTINUITY_CLAUDE-platform-evolution.md` to reflect completion of Phase 5E (Wazuh removal), including marking Phase 5C (UDM Pro syslog) as USER CONFIRMED COMPLETE, Phase 5D as SKIPPED, and Phase 5E as COMPLETE with resource reclamation metrics (~221Gi storage, ~10Gi memory, ~2.8 CPU cores). Committed as `10fafe0`.

2. **Disable Noisy SensitiveFileAccessed Alert** - Commented out the `SensitiveFileAccessed` PrometheusRule alert in `kubernetes/apps/monitoring/kube-prometheus-stack/app/prometheusrule-security.yaml` due to excessive false positives from legitimate system operations. Committed as `ffd5398` (after rebase from `c077f4a`).

3. **Tune VictoriaLogsNoRecentLogs Alert** - Adjusted alert threshold from 10 minutes to 30 minutes in `kubernetes/apps/monitoring/victoria-logs/app/prometheusrule.yaml` to accommodate scheduled syslog transmissions (every ~15 minutes) from UDM Pro and Synology NAS. Committed as `6342dff`.

## Critical References

- `thoughts/ledgers/CONTINUITY_CLAUDE-platform-evolution.md` - Master continuity ledger tracking all 6 phases
- `claudedocs/phase5e-wazuh-removal-completion.md` - Comprehensive Phase 5E completion document with resource reclamation audit
- `claudedocs/wazuh-capability-assessment.md` - Phase 5A capability mapping documenting Wazuh replacement strategy

## Recent Changes

- `thoughts/ledgers/CONTINUITY_CLAUDE-platform-evolution.md:92-95` - Marked Phase 5 Implementation section complete
- `thoughts/ledgers/CONTINUITY_CLAUDE-platform-evolution.md:125-127` - Updated status progression (Phase 5E complete → Phase 6 next)
- `thoughts/ledgers/CONTINUITY_CLAUDE-platform-evolution.md:141-143` - Resolved Wazuh-related open questions
- `thoughts/ledgers/CONTINUITY_CLAUDE-platform-evolution.md:155-156` - Added Phase 5E commit hash and documentation reference
- `kubernetes/apps/monitoring/kube-prometheus-stack/app/prometheusrule-security.yaml:32-48` - Commented out SensitiveFileAccessed alert with note "DISABLED: Too noisy"
- `kubernetes/apps/monitoring/victoria-logs/app/prometheusrule.yaml:63-77` - Increased VictoriaLogsNoRecentLogs threshold from 10m to 30m with explanatory comment

## Learnings

### Alert Tuning for Home-Lab Patterns

1. **Scheduled Syslog Pattern**: Home network devices (UDM Pro, Synology NAS) transmit syslog on schedules (~15 minutes) rather than real-time streams. Alert thresholds must account for this pattern to avoid false positives.

2. **eBPF Monitoring Sensitivity**: Tetragon's `monitor-sensitive-files` TracingPolicy triggers on legitimate system operations (systemd, kubelet accessing /etc/passwd, /etc/shadow). Without sophisticated context filtering, file access monitoring generates excessive noise. The TracingPolicy remains active for observability, but alerting was disabled.

3. **Alert Preservation Strategy**: When disabling noisy alerts, preserve commented-out definitions in manifests for future re-enablement with improved tuning rather than deleting entirely.

4. **Remaining Active Alerts**: 4 Tetragon security alerts remain operational:
   - PrivilegeEscalationDetected (T1548) - sys_setuid/sys_setgid monitoring
   - AbnormalProcessExecution (T1204) - /tmp and /dev/shm execution
   - SuspiciousNetworkActivity (T1071) - TCP connections to sensitive ports
   - RepeatedAuthenticationFailures (T1110) - su/sudo/ssh auth attempts

### Git Workflow with Pre-commit Hooks

- Pre-commit hooks automatically fix trailing whitespace and end-of-file issues
- After hook auto-fixes, must re-stage the corrected file before committing
- Git push can fail if remote has diverged; use `git pull --rebase origin main` before retrying push

### Phase 5E Resource Reclamation

Phase 5E successfully removed entire Wazuh deployment:
- **Pods removed**: 10 (wazuh-manager, wazuh-dashboard, wazuh-indexer, wazuh-agent daemonset)
- **Services removed**: 6 (manager, dashboard, indexer, agent services)
- **Workloads removed**: 5 (StatefulSets, DaemonSets, Deployments)
- **CronJobs removed**: 2 (backup jobs)
- **PVCs removed**: 12 (~221Gi storage reclaimed)
- **Resources reclaimed**: ~221Gi storage + ~10Gi memory + ~2.8 CPU cores

Replacement stack operational:
- Tetragon: 4 pods Running (1 operator + 3 node agents)
- VictoriaLogs: 1 pod Running, receiving external syslog on TCP/UDP port 514
- PrometheusRules: 5 security alerts deployed (1 now disabled due to noise)

## Post-Mortem (Required for Artifact Index)

### What Worked

- **Incremental Ledger Updates**: Making 5 separate targeted edits to different sections of the continuity ledger rather than one large edit ensured precision and reduced risk of conflicting changes. Each edit addressed a specific aspect (implementation status, progression, questions, working set, timestamp).

- **Commented Alert Disabling**: Preserving the SensitiveFileAccessed alert definition as comments rather than deleting allows easy re-enablement with improved tuning in future. The pattern of adding explanatory comments ("DISABLED: Too noisy", "Tuned for scheduled syslog sources") provides context for why changes were made.

- **Git Rebase Workflow**: When git push failed due to remote divergence, `git pull --rebase origin main` successfully resolved conflicts and maintained clean linear history.

- **Alert Threshold Analysis**: Analyzing the syslog transmission pattern (15-minute schedule) and doubling the alert threshold (10m → 30m) provided adequate buffer while still catching real failures within 30 minutes.

### What Failed

- **Initial Push Attempt**: First `git push` failed because remote had commits not present locally (c739602). Required pull/rebase before successful push.

- **Pre-commit Hook on First Commit**: First commit attempt for ledger update failed due to trailing whitespace in `claudedocs/phase5e-wazuh-removal-completion.md`. Hook auto-fixed and required re-staging before successful commit.

- **SensitiveFileAccessed Alert Design**: Alert fired on every legitimate system operation accessing /etc/passwd, /etc/shadow, SSH keys. Without context-aware filtering (distinguishing systemd/kubelet from malicious processes), this alert type is too noisy for practical use in home-lab environment.

### Key Decisions

- **Decision**: Disable SensitiveFileAccessed alert entirely rather than tune threshold
  - Alternatives considered: Increase threshold duration, add namespace filters, add process name exclusions
  - Reason: Root cause is lack of context-aware filtering. Alert triggers on legitimate system operations (systemd, kubelet) that cannot be excluded via simple metric filters. Without eBPF process context filtering (beyond what current TracingPolicy provides), any threshold would generate false positives. Preservation as commented code allows re-enablement if Tetragon gains better context filtering capabilities.

- **Decision**: Increase VictoriaLogsNoRecentLogs from 10m to 30m (3x increase)
  - Alternatives considered: 20m (less aggressive), 60m (more conservative)
  - Reason: Syslog sources send every ~15 minutes. 10m threshold didn't account for schedule variance and fired between transmissions. 30m provides one full interval (15m) plus buffer (15m) for delays while still detecting real failures within reasonable timeframe. 60m would be too slow to detect actual problems.

- **Decision**: Skip Phase 5D (Parallel Run Period) as documented in ledger
  - Alternatives considered: Run Wazuh + Tetragon in parallel for 2 weeks validation
  - Reason: User validated UDM Pro syslog working with VictoriaLogs (Phase 5C complete), Tetragon alerts operational (Phase 5B complete). Wazuh provided no unique capabilities beyond what replacement stack offers (see `claudedocs/wazuh-capability-assessment.md`). Parallel run would waste resources without additional validation value.

## Artifacts

- `thoughts/ledgers/CONTINUITY_CLAUDE-platform-evolution.md` - Updated continuity ledger (commit 10fafe0)
- `claudedocs/phase5e-wazuh-removal-completion.md` - Phase 5E completion documentation (read-only reference)
- `kubernetes/apps/monitoring/kube-prometheus-stack/app/prometheusrule-security.yaml` - SensitiveFileAccessed alert disabled (commit c077f4a/ffd5398)
- `kubernetes/apps/monitoring/victoria-logs/app/prometheusrule.yaml` - VictoriaLogsNoRecentLogs threshold tuned (commit 6342dff)

## Action Items & Next Steps

1. **Monitor Alert Behavior**: Observe VictoriaLogsNoRecentLogs alert over next 24-48 hours to confirm 30-minute threshold eliminates false positives while still catching real issues.

2. **Verify Flux Reconciliation**: Confirm Flux reconciles the alert changes (both SensitiveFileAccessed disable and VictoriaLogsNoRecentLogs tuning) and Prometheus reloads configuration successfully. Check with `flux get kustomizations -A --context home` and `kubectl -n monitoring logs -l app.kubernetes.io/name=prometheus --context home`.

3. **Phase 6 Planning** (Next Major Phase): Begin Codeberg Migration when ready. Phase 6 substeps from continuity ledger:
   - Deploy Forgejo runners (namespace, runner pods, RBAC)
   - Repository migration (create Codeberg org/repos, migrate home-ops, configure Flux webhook)
   - CI/CD pipeline migration (choose Woodpecker vs Forgejo Actions, migrate workflows, configure secrets)
   - Finalize migration (archive GitHub repo, update docs, monitor 2 weeks, delete GitHub repo)

4. **Optional Alert Re-enablement Research**: If Tetragon adds improved context filtering capabilities in future releases, consider re-enabling SensitiveFileAccessed alert with process context filters to exclude legitimate system operations.

## Other Notes

### Phase 5E Status Summary

Phase 5 (Wazuh Migration) is now **COMPLETE** across all substeps:
- ✅ Phase 5A: Wazuh Capability Assessment (complete)
- ✅ Phase 5B: PrometheusRule CRDs deployed (complete, 1 alert disabled this session)
- ✅ Phase 5C: UDM Pro syslog → VictoriaLogs (USER CONFIRMED COMPLETE)
- ✅ Phase 5D: Parallel run period (SKIPPED per user decision)
- ✅ Phase 5E: Wazuh removal (COMPLETE - all components removed)

### Current Monitoring Stack

**Observability (LGTM)**:
- VictoriaLogs: Receiving external syslog from UDM Pro (192.168.35.15:514 TCP/UDP)
- Prometheus + Thanos: Metrics collection with S3 long-term storage
- Grafana: Visualization with datasources for all components
- Alertmanager: Centralized alerting with Discord integration

**Security**:
- Tetragon: eBPF runtime security (4 pods Running, 4 alerts active)
- TracingPolicies: sensitive-files, network-egress, privilege-escalation

**Alert Status**:
- kube-prometheus-stack: 46 infrastructure alerts
- VictoriaLogs: 5 health alerts (1 tuned this session)
- Tetragon: 4 security alerts active (1 disabled this session: SensitiveFileAccessed)

### Key File Locations

**Continuity & Documentation**:
- `thoughts/ledgers/CONTINUITY_CLAUDE-platform-evolution.md` - Master project ledger
- `claudedocs/phase5*-*.md` - Phase 5 completion documents

**Alert Configurations**:
- `kubernetes/apps/monitoring/kube-prometheus-stack/app/prometheusrule-security.yaml` - Tetragon security alerts
- `kubernetes/apps/monitoring/victoria-logs/app/prometheusrule.yaml` - VictoriaLogs health alerts

**Tetragon Policies**:
- `kubernetes/apps/security/tetragon/app/tracingpolicies/sensitive-files.yaml` - File access monitoring
- `kubernetes/apps/security/tetragon/app/tracingpolicies/network-egress.yaml` - Network connection monitoring
- `kubernetes/apps/security/tetragon/app/tracingpolicies/privilege-escalation.yaml` - Privilege escalation monitoring

### Next Session Resume

To resume this work stream in a new session:
```bash
/resume_handoff thoughts/shared/handoffs/platform-evolution/2026-01-08_08-34-30_alert-tuning.md
```

Or load the continuity ledger directly:
```bash
cat thoughts/ledgers/CONTINUITY_CLAUDE-platform-evolution.md
```

Current status: Phase 5 complete, Phase 6 (Codeberg Migration) is next major milestone.
